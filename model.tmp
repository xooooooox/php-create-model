<?php


namespace app\model;


use \Closure;
use \Throwable;
use Illuminate\Database\Connection;
use support\Model as BaseModel;


/**
 * %s %s
 * Class %s
 * @package app\model
 */
class %s extends BaseModel
{

    /**
     * 实际表名
     * @var string
     */
    protected $table = '%s';

    /**
     * 指示是否自动维护时间戳
     * @var bool
     */
    public $timestamps = false;

    /**
     * 时间戳存储格式
     * @var string
     */
    protected $dateFormat = 'U';



    /**
     * @param object|null $object
     * @return array
     */
    public static function ObjectToArray(object|null $object) : array {
        $bag = json_decode(json_encode($object),true);
        if (!is_array($bag)){
            return [];
        }
        return $bag;
    }

    /**
     * @param array $insert
     * @return int
     */
    public static function AddOne(array $insert = []) : int {
        if ($insert === []){
            return 0;
        }
        return static::query()->insertGetId($insert);
    }

    /**
     * @param int $id
     * @return int
     */
    public static function DelOne(int $id) : int {
        $rows = static::query()
            ->where('id',$id)
            ->delete();
        if (!is_int($rows)){
            return 0;
        }
        return $rows;
    }

    /**
     * @param int $id
     * @param array $update
     * @return int
     */
    public static function ModOne(int $id, array $update = []) : int {
        if ($update === []){
            return 0;
        }
        $rows = static::query()
            ->where('id',$id)
            ->update($update);
        if (!is_int($rows)){
            return 0;
        }
        return $rows;
    }

    /**
     * @param int $id
     * @return bool
     */
    public static function Exists(int $id) : bool {
        $first = static::query()
            ->where('id',$id)
            ->first(['id']);
        $bag = static::ObjectToArray($first);
        if (isset($bag['id'])){
            return true;
        }
        return false;
    }

    /**
     * @param int $id
     * @param array|string[] $cols
     * @return array
     */
    public static function AscFirst(int $id, array $cols = ['*']) : array {
        $first = static::query()
            ->where('id',$id)
            ->orderBy('id')
            ->first($cols);
        return static::ObjectToArray($first);
    }

    /**
     * @param int $id
     * @param array|string[] $cols
     * @return array
     */
    public static function DescFirst(int $id, array $cols = ['*']) : array {
        $first = static::query()
            ->where('id',$id)
            ->orderByDesc('id')
            ->first($cols);
        return static::ObjectToArray($first);
    }

    /**
     * database transaction
     * @param Closure $callback need return bool value, true auto commit, and false auto rollback
     * @param Closure $except  handle the exception information thrown, value is getMessage()
     * @param int $attempts attempts times
     * @return bool result of transaction execute
     */
    public static function Transaction(Closure $callback, Closure $except, int $attempts = 1) : bool  {
        if ($attempts > 3){
            $attempts = 3;
        }
        if ($attempts <= 0) {
            return false;
        }
        try {
            $attempts--;
            $conn = static::query()->getConnection();
            $conn->beginTransaction();
            $success = $callback($conn);
            if ($success === true){
                $conn->commit();
            }else{
                $conn->rollBack();
            }
        }catch(Throwable $e){
            if (is_callable($except)){
                $except($e->getMessage());
            }
            $success = false;
        }
        if ($success === false && $attempts > 0){
            return static::Transaction($callback,$except,$attempts);
        }
        return $success;
    }

    /**
     * @param Connection $conn
     * @param array $insert
     * @return int
     */
    public static function ConnectAddOne(Connection $conn, array $insert = []) : int {
        if ($insert === []){
            return 0;
        }
        return $conn->query()->insertGetId($insert);
    }

    /**
     * @param Connection $conn
     * @param int $id
     * @return int
     */
    public static function ConnectDelOne(Connection $conn, int $id) : int {
        $rows = $conn->query()
            ->where('id',$id)
            ->delete();
        if (!is_int($rows)){
            return 0;
        }
        return $rows;
    }

    /**
     * @param Connection $conn
     * @param int $id
     * @param array $update
     * @return int
     */
    public static function ConnectModOne(Connection $conn, int $id, array $update = []) : int {
        if ($update === []){
            return 0;
        }
        $rows = $conn->query()
            ->where('id',$id)
            ->update($update);
        if (!is_int($rows)){
            return 0;
        }
        return $rows;
    }

    /**
     * @param Connection $conn
     * @param int $id
     * @return bool
     */
    public static function ConnectExists(Connection $conn, int $id) : bool {
        $first = $conn->query()
            ->where('id',$id)
            ->first(['id']);
        $bag = static::ObjectToArray($first);
        if (isset($bag['id'])){
            return true;
        }
        return false;
    }

    /**
     * @param Connection $conn
     * @param int $id
     * @param array|string[] $cols
     * @return array
     */
    public static function ConnectAscFirst(Connection $conn, int $id, array $cols = ['*']) : array {
        $first = $conn->query()
            ->where('id',$id)
            ->orderBy('id')
            ->first($cols);
        return static::ObjectToArray($first);
    }

    /**
     * @param Connection $conn
     * @param int $id
     * @param array|string[] $cols
     * @return array
     */
    public static function ConnectDescFirst(Connection $conn, int $id, array $cols = ['*']) : array {
        $first = $conn->query()
            ->where('id',$id)
            ->orderByDesc('id')
            ->first($cols);
        return static::ObjectToArray($first);
    }

}